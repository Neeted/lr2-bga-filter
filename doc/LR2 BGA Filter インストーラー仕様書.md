# LR2 BGA Filter インストーラー仕様書

## 概要

LR2 BGA Filterのインストール/アンインストール作業を自動化する。レジストリのバックアップ、TrustedInstaller権限の必要なレジストリ操作が必要となる。PowerShellスクリプトでの実装は煩雑なため、実行ファイル形式でのインストール/アンインストール方法を実装する。

## 想定配布パッケージ

インストーラー/アンインストーラーを実装したい。

```text
/ (root)
├── LR2BGAFilter.ax   (フィルター本体)
├── R2BGAFilterConfigurationTool.bat (設定画面起動バッチ)
├── インストーラー
├── アンインストーラー
└── README.md
```

## インストール処理手順

対象となるレジストリやフィルターはいずれも32bit版。

### 1. LAV Video Decoder, Splitterの存在を確認

LAV Video Decoderの存在が前提となるので確認する。

* 対象レジストリ: `HKEY_LOCAL_MACHINE\SOFTWARE\Classes\WOW6432Node\CLSID\{083863F1-70DE-11D0-BD40-00A0C911CE86}\Instance`

1. 対象レジストリに以下のキーが存在することを確認、1つでもない場合はLAVがインストールされていないとみなしインストール作業を進めないようにする。

    ```text
    キー, 名前
    {171252A0-8820-4AFE-9DF8-5C92B2D66B04}, LAV Splitter
    {B98D13E7-55DB-4385-A33D-09FD1BA26338}, LAV Splitter Source
    {EE30215D-164F-4A92-A4EB-9D4C13390F9F}, LAV Video Decoder
    ```

2. LAVがインストールされていない場合は「LAVFilters (x86)をインストールしてください」と警告を出す。

### 2. LAVのメリット値を変更

1. 「LR2 BGA Filter用に以下のフィルターのメリット値を変更します」と警告を出す。メリット値についての簡単な説明も表示する。

    | フィルタ名 | レジストリの場所 | 設定メリット値 |
    | :-------- | :-------------- | :------------ |
    | LAV Splitter | `HKEY_LOCAL_MACHINE\SOFTWARE\Classes\WOW6432Node\CLSID\{083863F1-70DE-11D0-BD40-00A0C911CE86}\Instance\{171252A0-8820-4AFE-9DF8-5C92B2D66B04}` | ff800004 |
    | LAV Splitter Source | `HKEY_LOCAL_MACHINE\SOFTWARE\Classes\WOW6432Node\CLSID\{083863F1-70DE-11D0-BD40-00A0C911CE86}\Instance\{B98D13E7-55DB-4385-A33D-09FD1BA26338}` | ff800004 |
    | LAV Video Decoder | `HKEY_LOCAL_MACHINE\SOFTWARE\Classes\WOW6432Node\CLSID\{083863F1-70DE-11D0-BD40-00A0C911CE86}\Instance\{EE30215D-164F-4A92-A4EB-9D4C13390F9F}` | ff800003 |

2. 以上のレジストリのバックアップを取る(`.\LAV_default.reg`などとする)。
3. メリット値を変更する。メリット値は`レジストリの場所`の`FilterData`のデータを書き換えることで行う。バイナリ値なので適切な方法で書き込むようにする。

### 3. Preferred Filterを設定

Windows 7以降の環境でメリット値よりも優先される設定値。これをデフォルト値から後述の設定値に書き換えることでLAVの使用またはメリット値へフォールバックさせる。対象フォーマットはバージョン違いなどを除きざっくり以下のもの。

| フォーマット       | 設定値            |
| :----------------- | :---------------- |
| DivX               | USE MERIT         |
| DVSD               | USE MERIT         |
| H264               | USE MERIT         |
| H265 / HEVC        | USE MERIT         |
| MJPG (Motion JPEG) | USE MERIT         |
| MPEG-1             | USE MERIT         |
| MPEG-2             | USE MERIT         |
| MPEG-4             | USE MERIT         |
| VC-1               | USE MERIT         |
| WMV1               | LAV Video Decoder |
| WMV2               | LAV Video Decoder |
| WMV3               | LAV Video Decoder |
| XviD               | USE MERIT         |

* 対象レジストリ: `\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\DirectShow\Preferred`

1. 「Preferred Filterの設定を変更します」と警告を出す。Preferred Filterについての簡単な説明も表示する。
2. 対象レジストリのバックアップを取る(`.\Preferred_default.reg`などとする)。
3. 対象レジストリの所有者が「TrustedInstaller」の場合は所有権を奪取する。
4. 対象レジストリを以下の設定値で上書きする。

    ```text
    name, value
    {41564D57-0000-0010-8000-00AA00389B71}, {EE30215D-164F-4A92-A4EB-9D4C13390F9F}
    {31564D57-0000-0010-8000-00AA00389B71}, {EE30215D-164F-4A92-A4EB-9D4C13390F9F}
    {32564D57-0000-0010-8000-00AA00389B71}, {EE30215D-164F-4A92-A4EB-9D4C13390F9F}
    {33564D57-0000-0010-8000-00AA00389B71}, {EE30215D-164F-4A92-A4EB-9D4C13390F9F}
    {31637661-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {31435641-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {78766964-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {58564944-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {34363268-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {34363248-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {43564548-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {31435648-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {3467706D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {3447504D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {3234706D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {3234504D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {3334706D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {3334504D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {47504A4D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {e436eb80-524f-11ce-9f53-0020af0ba770}, {ABCD1234-0000-0000-0000-000000000000}
    {7634706D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {5634504D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {7334706D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {5334504D-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {e436eb81-524f-11ce-9f53-0020af0ba770}, {ABCD1234-0000-0000-0000-000000000000}
    {e06d8026-db46-11cf-b4d1-00805f6cbbea}, {ABCD1234-0000-0000-0000-000000000000}
    {64737664-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {30357864-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {30355844-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {35363248-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {31435657-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {64697678-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    {44495658-0000-0010-8000-00AA00389B71}, {ABCD1234-0000-0000-0000-000000000000}
    ```

5. 所有権を奪取していた場合は所有者を「TrustedInstaller」に戻す。

### LR2 BGA Filterをインストール

1. 「LR2 BGA Filterをインストールします」と表示する。
2. `regsvr32 .\LR2BGAFilter.ax`としたときと同じようにフィルターを登録する。
3. 「LR2 BGA Filterのインストールが完了しました。LAV Video Decoderの設定はOutput FormatsのRGB32のみにチェックを付けた状態でご利用ください。念のため再起動/サインアウトをお勧めします。」と表示する。

## アンストール処理手順

基本的にはインストールの逆。バックアップした設定を戻すか尋ねるようにする。

### 1 LAVのメリット値をデフォルトに戻す

1. 戻すか尋ねる。
2. バックアップがない場合はバックアップが見つからないので戻せなかったと表示し、この処理は諦める。
3. `.\LAV_default.reg`などとして保存していた値を戻す。

### 3. Preferred Filterの設定をデフォルトに戻す

* 対象レジストリ: `\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\DirectShow\Preferred`

1. 戻すか尋ねる。
2. バックアップがない場合はバックアップが見つからないので戻せなかったと表示し、この処理は諦める。
3. 対象レジストリの所有者が「TrustedInstaller」の場合は所有権を奪取する。
4. バックアップをしていた(`.\Preferred_default.reg`などとしているはず)データを戻す。
5. 所有権を奪取していた場合は所有者を「TrustedInstaller」に戻す。

### 4. LR2 BGA Filterをアンインストール

1. 「LR2 BGA Filterをアンインストールします」と表示する。
2. `regsvr32 -u .\LR2BGAFilter.ax`としたときと同じようにフィルターの登録を解除する。
3. 「LR2 BGA Filterのアンインストールが完了しました。念のため再起動/サインアウトをお勧めします。」と表示する。
