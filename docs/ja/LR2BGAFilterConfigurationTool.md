# LR2BGAFilterConfigurationTool

## 概要

LR2BGAFilterConfigurationToolは、LR2BGAFilterの設定を行うためのツールです。

## 使い方

1. `LR2BGAFilterConfigurationTool.bat` を実行します。
2. 各種設定を行います。
3. `OK` ボタンを押して設定を保存します。

## 設定項目

### LR2 Output

- [ ] Dummy: LR2にダミー黒画面(1x1)を1フレームだけ出力します。
- [ ] Passthrough: 入力解像度のままLR2に出力します。黒帯除去は適用されます。
- [ ] Keep Aspect: 入力動画のアスペクト比を維持するために黒帯を付加してLR2に出力します。
- [ ] Limit FPS: LR2に出力するフレームレートを制限します。
- Size: LR2に出力する解像度を設定します。**スキンのBGA描画領域**に合わせることを推奨します。きちんと合わせてKeep Aspectを有効にすればLR2側でのリサイズが発生しないのでアスペクト比維持が実現できます。
- Algo: リサイズアルゴリズムを選択します。
  - Nearest Neighbor: 最速ですが画質は低いです。
  - Bilinear: パフォーマンスと画質のバランスが良いです。全力で並列化されています。
- Brightness: スライダーでBGAの輝度を調整します。

### External Window

ドラッグで移動が可能です。

- [ ] Enable: 外部ウィンドウでBGAを表示します。
- [ ] Passthrough: 入力解像度のまま外部ウィンドウに出力します。Sizeで設定した値は無視されます。黒帯除去は適用されます。
- [ ] Keep Aspect: 入力動画のアスペクト比を維持するために黒帯を付加して外部ウィンドウに出力します。
- Pos: 外部ウィンドウの表示位置を設定します。マウスで移動した位置は自動で保存されます。
- Size: 外部ウィンドウのサイズを設定します。
- Algo: リサイズアルゴリズムを選択します。LR2と外部ウィンドウで別々に設定できます。
- Z-Order: 外部ウィンドウのZ-Orderを設定します。
  - Top: 常に最前面に表示します。
  - Bottom: 起動時に最背面に表示します。
- Brightness: スライダーでBGAの輝度を調整します。黒一色のオーバーレイウィンドウの透明度を調整します。これによりOBSなどのキャプチャソフトで輝度調整前のBGAをキャプチャできます。

### External Window Close Triggers

- [ ] R-Click: 外部ウィンドウを右クリックで閉じるようになります。
- [ ] Gamepad: ゲームパッドの指定したボタンを押すと外部ウィンドウを閉じます。
  - [ ] ID: ゲームパッドのIDを設定します。1つしかゲームパッドを接続していない場合は0のはずです。
  - [ ] Btn: ゲームパッドのボタン番号を設定します。
  - IDとBtnは後述の設定で有効化できるデバッグウィンドウの表示を参考にしてください。
- [ ] Keyboard: キーボードの指定したキーを押すと外部ウィンドウを閉じます。
  - Key Code: キーコードを設定します。16進数で入力します。例: 0xD (Enterキー)。デバッグウィンドウの表示を参考にしてください。
- [ ] Result Screen: リザルト画面遷移時に自動で外部ウィンドウを閉じます。
  - *注意*: **この機能はLR2のメモリを読み取ることでリザルト画面遷移を検知します。クリーンな実装とは言えないので気になる方は使用しないでください。**

### Auto Letterbox Removal

16:9へのクロップと4:3へのクロップに対応しています。

- [ ] Enable: 黒帯除去を有効にします。
- Threshold: 黒帯除去の閾値を設定します。閾値以下の輝度のピクセルを黒として判定に使います。
- Stable: 黒帯除去切り替えの連続判定回数を設定します。200ms秒に1回判定を行うので、3を設定すると600ms秒以上黒帯が続かないと黒帯が除去されません。

### Other

- [ ] Debug Mode (Info Window): 動画再生中にデバッグウィンドウを表示します。ゲームパッドのボタン番号やキーコードなどを確認できます。
- [ ] Auto Open Properties: 動画再生時に設定画面が自動で開くようになります。初期設定時に便利です。

## 補足説明

- 設定値はレジストリ`HKEY_CURRENT_USER\SOFTWARE\LR2BGAFilter`に保存されます。設定ファイルではなくレジストリを利用する理由は、動画再生時にファイルIOを発生させず起動速度を低下させないためです。
- 処理順序が分かりにくいかもしれないので捕捉します。
  - 黒帯除去は入力されたフレームに対して最初に行われます。
  - なのでLR2用に1:1で黒帯が付いているBGAに黒帯除去を適用して、Keep Aspect無効で出力すると、縦に引き伸ばされたBGAが表示されると思います。Keep Aspectを有効にすれば元の1:1で黒帯が付いたBGAと同じ見た目になると思います。
  - 元が16:9で黒帯が付いていないBGAでは黒帯除去は適用されず、Keep Aspect有効だと出力サイズに合わせて黒帯が付加されます。
  - **つまり何が言いたいのかというとAuto Letterbox RemovalとKeep Aspectは常に両方有効にしておくのがおすすめです。** BGA表示領域が1:1じゃないスキンでもいい感じに表示されるはずです。
